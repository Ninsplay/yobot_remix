<!DOCTYPE html>

<head>
    <title>出刀记录</title>
    <meta charset="utf-8" content='width=480' name='viewport'/>
    <script src="/yobot-depencency/vue@2.6.11/dist/vue.min.js"></script>
    <script src="/yobot-depencency/axios@0.19.2/dist/axios.min.js"></script>
    <script src="/yobot-depencency/element-ui@2.13.0/lib/index.js"></script>
    <link href="/yobot-depencency/element-ui@2.13.0/lib/theme-chalk/index.css" rel="stylesheet">
    <script src="/yobot-depencency/jquery@2.1.1/jquery.min.js"></script>
    <script src="/yobot-depencency/yocool@final/princessadventure/yocool.js"></script>
    <link href="/yobot-depencency/yocool@final/princessadventure/style.css" rel="stylesheet">

    <style>
        .el-table td,
        .el-table th {
            text-align: center;
        }

        .el-popover {
            white-space: pre-wrap;
        }

        .progress-btn {
            width: 95px;
            height: 36px;
            padding: 10px 12px;
        }

        .pc-box {
            width: 1336px;
            margin: 0 auto;
        }

        .el-table {
            width: 1336px;
            margin: 0 auto;
        }

        .el-button + .el-button {
            margin-left: 0px;
        }

        .el-col-24 {
            width: 95%;
            margin: 0px 2.5%;
        }

        .el-progress-bar__inner {
            background-color: var(--secondary-color-1);
        }


        .el-progress-bar__outer {
            background-color: #ffffff;
        }

        @media only screen and (max-width: 1080px) {

            .el-date-editor.el-input,
            .el-date-editor.el-input__inner {
                width: 150px;
            }

            .damage-detail-box {
                display: inline-block;
                width: 130px;
            }

            .el-dialog {
                width: 80%;
            }
        }
    </style>
</head>

<body>
<div id="app">
    <div id="topToolbar">
        <el-page-header @back="location='..'" content=""></el-page-header>

        <el-menu :default-active="activeIndex" @select="handleTitleSelect" class="el-menu-demo" mode="horizontal">
            <el-menu-item index="6">排名</el-menu-item>
            <el-menu-item index="5">我的</el-menu-item>
            <el-menu-item index="4">统计</el-menu-item>
            <el-menu-item index="3">查刀</el-menu-item>
            <el-menu-item index="2">预约</el-menu-item>
            <el-menu-item index="1">面板</el-menu-item>
        </el-menu>
    </div>
    <h1 style="text-align:center">出刀记录
        <el-popover effect="light" placement="top" trigger="hover">
            1.红名表示今日已使用过SL<br>2.有色背景表示已完成今日出刀<br>3.点击昵称或详细可以查看详细出刀情况<br>4.点击成员头像可以查看该成员的所有历史出刀记录<i
                class="el-icon-question" slot="reference"></i></el-popover>
    </h1>
    <el-date-picker @change="report_day" placeholder="选择日期" type="date" v-model="reportDate"></el-date-picker>
    <el-button @click="selectUnfinished" class="progress-btn" type="warning">选中未完成</el-button>
    <el-button @click="sendRemindVisible = true" class="progress-btn" type="primary">提醒出刀</el-button>
    <el-dialog :visible.sync="sendRemindVisible" title="警告">
        <p>您确定要向[[ multipleSelection.length ]]名成员发送提醒吗</p>
        <el-form>
            <el-form-item label="提醒类型" label-width="120">
                <el-radio-group v-model="send_via_private">
                    <el-switch active-text="私聊消息" inactive-text="群聊消息" v-model="send_via_private"></el-switch>
                </el-radio-group>
            </el-form-item>
        </el-form>
        <span class="dialog-footer" slot="footer">
				<el-button @click="sendRemindVisible = false" type="primary">取消</el-button>
				<el-button @click="sendRequest('send_remind'),sendRemindVisible = false" type="danger">确定</el-button>
			</span>
    </el-dialog>
    <template v-if="progressData.length > 0">
        <el-button @click="viewTails" class="progress-btn" type="primary">尾刀一览</el-button>
        <el-row class='el-table' style="margin: auto;padding-bottom: 2%;">
            <el-col style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                <div>
                    <p>成员[[ members.length ]]，已出[[ progressData.reduce((s,i)=>s+i.finished,0) ]]，剩余[[
                        members.length
                        *
                        3-progressData.reduce((s,i)=>s+i.finished,0) ]]</p>
                </div>
                <div>
                    <p>[[ ((progressData.reduce((s,i)=>s+i.finished,0)/(members.length*3))*100).toFixed(1) ]]%</p>
                </div>
            </el-col>
            <el-col :span="24">
                <el-progress
                        :percentage="(progressData.reduce((s,i)=>s+i.finished,0)/members.length/3*100).toFixed(1)"
                        :show-text="false" :stroke-width="16"></el-progress>
            </el-col>
        </el-row>
        <el-dialog :visible.sync="tailsDataVisible" title="未完成的尾刀一览">
            <template v-if="tailsData.length > 0">
                <el-table :data="tailsData">
                    <el-table-column label="QQ号" prop="qqid" sortable width="120"></el-table-column>
                    <el-table-column label="昵称" prop="nickname" sortable width="200"></el-table-column>
                    <el-table-column label="boss" prop="boss" width="80"></el-table-column>
                    <el-table-column label="尾刀伤害" prop="damage" sortable width="120">
                        <template slot-scope="scope">[[ scope.row.damage.toLocaleString() ]]</template>
                    </el-table-column>
                    <el-table-column label="留言" prop="message"></el-table-column>
                </el-table>
            </template>
            <template v-else>
                没有尾刀
            </template>
        </el-dialog>

        <!-- 这里有个是否是手机的判断 -->
        <el-table :data="progressData" :row-class-name="getRowClass" :span-method="arraySpanMethod" @cell-click="clickCell"
                  @selection-change="handleSelectionChange" ref="multipleTable" stripe v-if="isMobile"
                  width="100%">
            <el-table-column type="selection" width="70"></el-table-column>
            <el-table-column label="成员" width="80">
                <template slot-scope="scope">
                    <el-avatar :src="'https://q1.qlogo.cn/g?b=qq&nk=' + scope.row.qqid + '&s=140'" @click.native="location='../'+scope.row.qqid+'/'"
                               shape="square"></el-avatar>
                </template>
            </el-table-column>
            <el-table-column label="昵称" width="200">
                <template slot-scope="scope">
						<span :style="{color: scope.row.sl == today ? '#ff0000' : 'var(--font-color)'}">[[
							scope.row.nickname ]]</span>
                </template>
            </el-table-column>
            <el-table-column label="今日" prop="finished" sortable width="80"></el-table-column>
            <el-table-column align="right" label="显示详细" type="expand">
                <template slot-scope="props">
                    <div>
                        第一刀:
                        <div class="damage-detail-box">
                            <template v-if="props.row.detail[0]">
                                <a v-html="csummary(props.row.detail[0])"></a>
                                <el-popover effect="light" placement="top" trigger="hover">[[
                                    cdetail(props.row.detail[0]) ]]<i class="el-icon-info" slot="reference"></i>
                                </el-popover>
                            </template>
                            <template v-else>
                                尚未出刀
                            </template>
                        </div>
                        <i :style="{ visibility: props.row.detail[1] ? 'visible' : 'hidden' }"
                           class='el-icon-plus'></i>
                        <div class="damage-detail-box">
                            <template v-if="props.row.detail[1]">
                                <a v-html="csummary(props.row.detail[1])"></a>
                                <el-popover effect="light" placement="top" trigger="hover">[[
                                    cdetail(props.row.detail[1]) ]]<i class="el-icon-info" slot="reference"></i>
                                </el-popover>
                            </template>
                            <template v-else-if="props.row.detail[0] && !props.row.detail[0].health_remain ">
                                剩余补偿刀未出
                            </template>
                            <template></template>
                        </div>
                    </div>
                    <div>
                        第二刀:
                        <div class="damage-detail-box">
                            <template v-if="props.row.detail[2]">
                                <a v-html="csummary(props.row.detail[2])"></a>
                                <el-popover effect="light" placement="top" trigger="hover">[[
                                    cdetail(props.row.detail[2]) ]]<i class="el-icon-info" slot="reference"></i>
                                </el-popover>
                            </template>
                            <template v-else>
                                尚未出刀
                            </template>
                        </div>
                        <i :style="{ visibility: props.row.detail[3] ? 'visible' : 'hidden' }"
                           class='el-icon-plus'></i>
                        <div class="damage-detail-box">
                            <template v-if="props.row.detail[3]">
                                <a v-html="csummary(props.row.detail[3])"></a>
                                <el-popover effect="light" placement="top" trigger="hover">[[
                                    cdetail(props.row.detail[3]) ]]<i class="el-icon-info" slot="reference"></i>
                                </el-popover>
                            </template>
                            <template v-else-if="props.row.detail[2] && !props.row.detail[2].health_remain ">
                                剩余补偿刀未出
                            </template>
                        </div>
                    </div>
                    <div>
                        第三刀:
                        <div class="damage-detail-box">
                            <template v-if="props.row.detail[4]">
                                <a v-html="csummary(props.row.detail[4])"></a>
                                <el-popover effect="light" placement="top" trigger="hover">[[
                                    cdetail(props.row.detail[4]) ]]<i class="el-icon-info" slot="reference"></i>
                                </el-popover>
                            </template>
                            <template v-else>
                                尚未出刀
                            </template>
                        </div>
                        <i :style="{ visibility: props.row.detail[5] ? 'visible' : 'hidden' }"
                           class='el-icon-plus'></i>
                        <div class="damage-detail-box">
                            <template v-if="props.row.detail[5]">
                                <a v-html="csummary(props.row.detail[5])"></a>
                                <el-popover effect="light" placement="top" trigger="hover">[[
                                    cdetail(props.row.detail[5]) ]]<i class="el-icon-info" slot="reference"></i>
                                </el-popover>
                            </template>
                            <template v-else-if="props.row.detail[4] && !props.row.detail[4].health_remain ">
                                剩余补偿刀未出
                            </template>
                        </div>
                    </div>
                </template>
            </el-table-column>
        </el-table>

        <div class="pc-box" v-else>
            <el-table :data="progressData" :row-class-name="getRowClass" :span-method="arraySpanMethod" @selection-change="handleSelectionChange"
                      ref="multipleTable" size="medium" stripe width="100%">
                <el-table-column label="SL" prop="sl" sortable width="75">
                    <template slot-scope="scope">
                        <template v-if="today==-1">
                            <i class="el-icon-folder-remove"></i>
                        </template>
                        <template v-else>
                            <i class="el-icon-star-off" style="color: #F56C6C" v-if="scope.row.sl==today"></i>
                            <i class="el-icon-star-on" style="color: #67C23A" v-else></i>
                        </template>
                    </template>
                </el-table-column>
                <el-table-column label="成员" width="60">
                    <template slot-scope="scope">
                        <el-avatar :src="'https://q1.qlogo.cn/g?b=qq&nk=' + scope.row.qqid + '&s=140'"
                                   @click.native="location='../'+scope.row.qqid+'/'"
                                   shape="square"></el-avatar>
                    </template>
                </el-table-column>
                <el-table-column label="昵称" prop="nickname" sortable width="180">
                </el-table-column>
                <el-table-column label="今日" prop="finished" sortable width="60"></el-table-column>
                <el-table-column label="第一刀">
                    <el-table-column label="尾刀" width="150">
                        <template slot-scope="scope" v-if="scope.row.detail[0]">
                            <a v-html="csummary(scope.row.detail[0])"></a>
                            <el-popover effect="light" placement="top" trigger="hover">[[
                                cdetail(scope.row.detail[0]) ]]<i class="el-icon-info" slot="reference"></i>
                            </el-popover>
                            <br><a v-html="behalf(scope.row.detail[0])"></a>
                        </template>
                    </el-table-column>
                    <el-table-column label="剩余刀" width="150">
                        <template slot-scope="scope" v-if="scope.row.detail[1]">
                            <a v-html="csummary(scope.row.detail[1])"></a>
                            <el-popover effect="light" placement="top" trigger="hover">[[
                                cdetail(scope.row.detail[1]) ]]<i class="el-icon-info" slot="reference"></i>
                            </el-popover>
                            <br><a v-html="behalf(scope.row.detail[1])"></a>
                        </template>
                    </el-table-column>
                </el-table-column>
                <el-table-column label="第二刀">
                    <el-table-column label="尾刀" width="150">
                        <template slot-scope="scope" v-if="scope.row.detail[2]">
                            <a v-html="csummary(scope.row.detail[2])"></a>
                            <el-popover effect="light" placement="top" trigger="hover">[[
                                cdetail(scope.row.detail[2]) ]]<i class="el-icon-info" slot="reference"></i>
                            </el-popover>
                            <br><a v-html="behalf(scope.row.detail[2])"></a>
                        </template>
                    </el-table-column>
                    <el-table-column label="剩余刀" width="150">
                        <template slot-scope="scope" v-if="scope.row.detail[3]">
                            <a v-html="csummary(scope.row.detail[3])"></a>
                            <el-popover effect="light" placement="top" trigger="hover">[[
                                cdetail(scope.row.detail[3]) ]]<i class="el-icon-info" slot="reference"></i>
                            </el-popover>
                            <br><a v-html="behalf(scope.row.detail[3])"></a>
                        </template>
                    </el-table-column>
                </el-table-column>
                <el-table-column label="第三刀">
                    <el-table-column label="尾刀" width="150">
                        <template slot-scope="scope" v-if="scope.row.detail[4]">
                            <a v-html="csummary(scope.row.detail[4])"></a>
                            <el-popover effect="light" placement="top" trigger="hover">[[
                                cdetail(scope.row.detail[4]) ]]<i class="el-icon-info" slot="reference"></i>
                            </el-popover>
                            <br><a v-html="behalf(scope.row.detail[4])"></a>
                        </template>
                    </el-table-column>
                    <el-table-column label="剩余刀" width="150">
                        <template slot-scope="scope" v-if="scope.row.detail[5]">
                            <a v-html="csummary(scope.row.detail[5])"></a>
                            <el-popover effect="light" placement="top" trigger="hover">[[
                                cdetail(scope.row.detail[5]) ]]<i class="el-icon-info" slot="reference"></i>
                            </el-popover>
                            <br><a v-html="behalf(scope.row.detail[5])"></a>
                        </template>
                    </el-table-column>
                </el-table-column>
                <el-table-column type="selection" width="60"></el-table-column>
            </el-table>
            <div style="width: 100%;">
                <el-button @click="viewInExcel" class="progress-btn" size="mini"
                           style="width: 115px;left: 600px;position: relative;">
                    <i class="el-icon-document">在Excel中查看</i></el-button>
            </div>
        </div>
    </template>
    <br>
    <div style="width: 100%;">
        <el-button @click="dropMemberVisible = true" class="progress-btn" style="margin-bottom: 20px;"><i
                class="el-icon-delete">删除</i>
        </el-button>
        <el-dialog :visible.sync="dropMemberVisible" title="警告">
            <p>您确定要删除这[[ multipleSelection.length ]]名成员吗</p>
            <span class="dialog-footer" slot="footer">
				<el-button @click="dropMemberVisible = false" type="primary">取消</el-button>
				<el-button @click="sendRequest('drop_member'),dropMemberVisible = false" type="danger">
					确定
				</el-button>
			</span>
        </el-dialog>
    </div>
    <template v-else>
        没有记录
    </template>
</div>
</body>
<script>
    var csrf_token = "{{ session['csrf_token'] }}";
</script>
<script src="{{ url_for('yobot_static', filename='clan/progress.js') }}"></script>

</html>